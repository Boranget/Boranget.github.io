---
title: Alhagi实现记录
date: 2024-11-17 21:35:19
updated: 2024-11-17 21:35:19
tags:
  - 编辑器
  - markdown
categories:
  - notes
---

# 参考资料

https://spec.commonmark.org/0.31.2/

# 字符和行

## 行/空行

- line ending：由换行符（U+000A）和回车符（U+000D）组成，如换行不加回车，回车不加换行，以及回车跟着换行
- line：0到多个字符（除line ending之外），后面跟着line ending
- blank line：一个行不包含任何字符或只包含空格（U+0020）或者tab（U+0009）

## 特殊字符

- tab的行为可以被理解为四个空格，但作为文本解析时还是tab
- 出于安全原因，应将文档中的null（U+0000）替换为替换字符（U+FFFD）
- 标点符号：`!`, `"`, `#`, `$`, `%`, `&`, `'`, `(`, `)`, `*`, `+`, `,`, `-`, `.`, `/` (U+0021–2F), `:`, `;`, `<`, `=`, `>`, `?`, `@` (U+003A–0040), `[`, `\`, `]`, `^`, `_`, \` (U+005B–0060), `{`, `|`, `}`, or `~` (U+007B–007E).

## 转义字符

- 任何ascii标点符号应该加上转义斜杠，除此之外的字符之前的转义斜杠应该被解析为文本斜杠。
- 被转义的字符应该作为纯文本，不再有md中符号的含义，
- 转义斜杠可以被转义斜杠转义，
- 行末尾添加一个转义斜杠会作为硬换行，
- 转义斜杠在代码块、代码段中、自动链接中或者原生HTML中不起作用
- 转义字符在其他内容中比如URL，link title、link reference 、以及围栏代码块的info string中是起作用的

## html实体和字符引用

- 合法的实体和字符引用可以在一些地方使用
- 实体和字符引用在代码块或者代码段（行内代码）中不被承认
- 实体和字符引用如果是不可参与md文档结构解析
- html实体为`&`+HTML实体名+`;`：https://html.spec.whatwg.org/entities.json
- 十进制字符引用：`&#`+（1-7位的）十进制编码+`;`，非法的unicode会被替换为替换字符
- 十六进制字符引用：`&#`+`X`或`x`+（1-6位的）十六进制编码+`;`
- 非法的字符引用会被替换为替换字符，但是非字符引用用原文显示
- 在html中，允许实体没有分号结尾，但是在md中不建议进行解析
- 不在html实体列表中的字符串不被解析
- 实体和字符引用在代码块，代码段中不解析
- 注意解析到URL中时会被URL编码
- 实体和字符引用解析后的结构符号不会有md符号的作用

# 块类型

## 叶子块 Leaf blocks

### 分割线Thematic breaks

- 开头最多能有三个空格
- 至少三个符号`-_*`
- 行尾可跟任意数量空格。
- 需要使用同意符号，不能混用
- 符号中间允许有任意数量空格或者tab分隔。
- 行不能有其他符号。
- 分割线会截止段落，上下无需空行。
- 如果使用中划线，会优先解析为被动标题（setext heading），想避免可以用其他符号。

### 标题 ATX heading

- 开头带1-6个`#`，可选的任意数量的关闭符号`#`（pound sign）
- 行头`#`后需要跟至少一个空格或者tab，除非标题为空
- 行尾`#`（如果有）前需要跟至少一个空格或者tab，其后只能跟空格或者tab，如果跟了其他内容则会作为标题内容处理
- 被转义的`#`不作为关闭序列
- 行开头允许最多有三个空格
- 标题在渲染内联结构之前会先trip空格
- 标题层级取决于开头`#`数量
- 标题会截止段落，上下无需空行
- 标题可为空

### 被动标题 Setext heading

- 被动标题中不能有空行
- 行开头允许最多有三个空格
- 下一行为被动标题下划线结构
- 该行不能为以下结构：
    - 围栏代码块
    - 标题
    - 分割线
    - 列表元素
    - html块
- 被动标题下划线
    - 被动标题下划线由`=-`两种符号组成，长度任意（1-∞）
    - 行开头允许最多有三个空格
    - 行结尾可以有任意数量的空格或者tab
    - `=`为一级标题，`-`为二级标题
- 标题的内容为解析了内联结构后的内容
- 一般标题前无需空行，但被动标题不能截止段落，所以当一个被动标题跟在段落后时，需要在段落后先跟一个空行，由于以上原因，被动标题可以有多行。
- 被动标题的内容与下划线不需要对齐（三个空格以下的缩进）
- 下划线内不能有空格或者tab
- 被动标题内容末尾的空格不会导致硬换行，斜杠也不会
- 由于块结构优先于内联，所以如果多行的内联代码框住了被动标题的整个结构，会优先解析为被动标题，其余内联结构同理。
- 被动标题下划线不能存在于列表或者引用的懒换行中
- 被动标题不能为空，否则会变为分割线
- 被动标题不能被解析为除段落外的其他块元素，否则被动标题下划线会解析为分割线
- 被动标题内容开头如果有特殊符号可以使用转义符转义
- 可以通过添加空行的方式避免不必要的被动标题形成

### 缩进代码块

- 缩进代码块由一个或多个由空行分隔的缩进代码块构成
- 一个缩进代码块由一系列非空行组成，每行开头需要有至少四个空格的缩进
- 代码块内容为去掉四个缩进空格后的文本原文，包括行尾换行或回车
- 缩进代码块没有信息字符串（相对于围栏代码块
- 缩进代码块无法截止段落，故在段落后缩进代码块之前必须有一个空行，反过来（缩进代码块后跟段落）不需要。
- 当与列表项同时存在时，优先解析为列表项（列表项会有忽略空行续的情况
- 只要收尾是由四个空格缩进的结构，则中间所有的空白行都会包括在同一个代码块内
- 缩进代码块无法截止段落
- 缩进代码块可以直接跟在（无需空行）其他块结构后或前
- 任何缩进小于四个空格的非空行都会立即结束代码块，故段落可直接跟在缩进代码块后
- 缩进代码块之后或者之前的空行不包括在缩进代码块内

### 围栏代码块

- 代码围栏由至少三个反引号或者波浪号组成，两种符合不可混用，且需要连续，中间不可穿插空格或者其他符号
- 代码围栏最多能有三个空格缩进
- 代码围栏后面可以跟info string，info string中不应该跟任何反引号，否则会被解析为行内代码（如果启动符号为波浪线则info string中波浪线和反引号均可以出现）
- 围栏代码块直到碰到同样格式（同种字符，相同或者更多数量字符）的代码围栏才会结束
- 如果启动代码围栏有N个缩进，则代码内容中每行都会去掉三个空格（不足三个全去掉）
- 结束代码围栏最多能有三个缩进（缩进无需与启动代码围栏对齐），其后只能跟空格或者tab并且会被忽略。当然也没有info string一说
- 如果到文档结尾（或者引用快结尾、列表项结尾）都没找到结束代码围栏，则启动围栏后所有内容都属于代码块内容
- 围栏代码块会截止段落，且前后无需空行
- 其余块结构也可以直接跟在围栏代码块前后，无需空行
- 代码块内容以原文显示，不进行行内渲染
- info string 中的第一个单词一般作为代码块中语言的声明，通常会在code元素中添加class`language-`如`class="language-java"`
- 代码块内容可以为空

### HTML

- HTML块由启动条件和结束条件组成

- HTML代码块内，所有内容被解析为原生的HTML，包括md结构字符

- 启动条件最多能有三个缩进

- 碰到结束条件关闭该块

- 碰到文档结尾或者行内容器的末尾关闭该块

- 如果碰到其他容器块则关闭该块

- 如果在第一行便碰到了开始条件和结束条件，则块只包含一行

- 七种情况

    - 情况1
        - 启动条件：由 `<pre`, `<script`, `<style`, or `<textarea` (大小写敏感),开头的行，followed by a space, a tab, the string `>`, or the end of the line.
        - 结束条件：行包含end tag `</pre>`, `</script>`, `</style>`, or `</textarea>` (大小写敏感，不需要匹配到开始标签)
    - 情况2
        - 启动条件：行开头为`<!--`
        - 结束条件：行包含  `-->`
    - 情况3
        - 启动条件：行开头为`<?`
        - 结束条件：行包含 `?>`
    - 情况4
        - 启动条件：行开头为` <!`后面跟着一个ASCII字符
        - 结束条件：行包含 `?>`
    - 情况5
        - 启动条件：行开头为`<![CDATA[`
        - 结束条件：行包含 `]]>`
    - 情况6
        - 启动条件： 行开头为`<` or `</` followed by one of the strings (大小写敏感) `address`, `article`, `aside`, `base`, `basefont`, `blockquote`, `body`, `caption`, `center`, `col`, `colgroup`, `dd`, `details`, `dialog`, `dir`, `div`, `dl`, `dt`, `fieldset`, `figcaption`, `figure`, `footer`, `form`, `frame`, `frameset`, `h1`, `h2`, `h3`, `h4`, `h5`, `h6`, `head`, `header`, `hr`, `html`, `iframe`, `legend`, `li`, `link`, `main`, `menu`, `menuitem`, `nav`, `noframes`, `ol`, `optgroup`, `option`, `p`, `param`, `search`, `section`, `summary`, `table`, `tbody`, `td`, `tfoot`, `th`, `thead`, `title`, `tr`, `track`, `ul`，后面跟着空格或者tab或者行结束，或者  `>`,  `/>`.
        - 结束条件：一个行，后面跟着一个空行
    - 情况7
        - 启动条件：行开头为一个完整的HTML开始标签( any [tag name](https://spec.commonmark.org/0.31.2/#tag-name) other than `pre`, `script`, `style`, or `textarea`)或者一个完整的结束标签，后面跟着0个或多个空格或者tab，再往后为行结尾（end of the line）
        - 结束条件：一个行，后面跟着一个空行

- HTML块只有在碰到该种类型的结束条件是才会被关闭，所以在其中又碰到开启条件时不会关闭该块或者开启一个新的块

    ```
    <table><tr><td>
    <pre>
    **Hello**,
    
    _world_.
    </pre>
    </td></tr></table>
    //==========
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE document SYSTEM "CommonMark.dtd">
    
    <document xmlns="http://commonmark.org/xml/1.0">
      <html_block>&lt;table&gt;&lt;tr&gt;&lt;td&gt;
    &lt;pre&gt;
    **Hello**,</html_block>
      <paragraph>
        <emph>
          <text>world</text>
        </emph>
        <text>.</text>
        <softbreak />
        <html_inline>&lt;/pre&gt;</html_inline>
      </paragraph>
      <html_block>&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</html_block>
    </document>
    ```

    

- 除了情况7外的其他HTML块都会截止段落

- 一个HTML块可以以结束标签开始

- 开放标签也并不需要关闭

- 若标签名在情况6的字符列表中，当碰到该字符串的时候（至少结尾有个分割），则开始条件已经达成，此时已经满足html块的启动条件

- 第一行的标签可以是部分的，只要在应该有空格的地方被分割

    ```
    <boranget
    name="">
    
    123
    //==========
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE document SYSTEM "CommonMark.dtd">
    
    <document xmlns="http://commonmark.org/xml/1.0">
      <paragraph>
        <html_inline>&lt;boranget
    name=&quot;&quot;&gt;</html_inline>
      </paragraph>
      <paragraph>
        <text>123</text>
      </paragraph>
    </document>
    ```

    

- 若标签名在情况6的字符列表中，开放标签并不需要完整包含到`>`，

- 如果标签名不在6列表中，则第一行中开始标签必须要完整，且该行只能有该启动标签。

- 在情况6中，开始条件不需要单独占用一个行，也可以只是行开头的部分字符。

- 情况6中，任何在没有碰到空行或者文档结尾时的内容都被包括在HTML块中

- 在情况7中，标签名可以为任何字符串，注意是标签名

- 情况7中，如果起始行不只有启动标签，则会解析为inline HTML

- 情况1-5都可以包含空行，因为他们的停止条件是固定的，直到碰到文档结尾或者引用结尾或者列表项结尾

- 结束标签可以和开始标签在同一行

- 在最后一行标签后的内容会包含在HTML块内

- 情况1-6都可以截止段落，故块前无需添加空行，但是对于6，在块结尾需要添加空行。

- 情况7无法截止段落

### 链接引用定义

- 链接标签由`[`开头，以`]`结尾
- 链接定义有两种情况，
    - 一种是被尖括号包裹的字符，其中不能保护任何未转义的尖括号，
    - 另一种是未被尖括号包裹的，其中不能包含ASCII控制字符以及空格，可以包含被转义的圆括号或者成对的圆括号
- 链接标题
    - 一种是被双引号包裹的字符串，可包含被转义的双引号
    - 一种是被单引号包裹的字符串，可包含被转义的单引号
    - 被圆括号包裹，可包含被转义的圆括号
    - 链接标题可分割多行，但不能包含空行
- 开头最多会存在三个空格的缩进
- 链接引用定义由链接标签开头，跟着一个冒号，接着可选的空格或者tab，或者最多一个行结束，跟着一个链接定义，再跟可选的空格或者tab或者最多一个行结束，在加一个可选的链接标题，如果链接标题存在，则必须添加一个空格或者制表符在链接定义之后。
- 链接引用定义并不会解析出一个结构出来，只是会在链接定义或者图片中引用
- 链接引用定义无法截止段落故其之前需要一个空行
- 连接引用定义可在引用之前或者之后定义
- 链接定义（第二个组成部分）不能被省略，但可以通过一个空的尖括号区间构建一个空定义

## 容器块



# 内联类型

